/**
 * コストオーバー残耐久のテスト
 */

import { getRespawnHealth } from './overCostHealthTable';

describe('getRespawnHealth', () => {
  describe('残コストが機体コスト以上の場合', () => {
    test('3000コスト、残6000 → 初期耐久800で復活', () => {
      expect(getRespawnHealth(3000, 800, 6000)).toBe(800);
    });

    test('2500コスト、残3000 → 初期耐久700で復活', () => {
      expect(getRespawnHealth(2500, 700, 3000)).toBe(700);
    });

    test('1500コスト、残3000 → 初期耐久520で復活', () => {
      expect(getRespawnHealth(1500, 520, 3000)).toBe(520);
    });

    test('残コストがちょうど機体コストと同じ → 初期耐久で復活', () => {
      expect(getRespawnHealth(3000, 800, 3000)).toBe(800);
      expect(getRespawnHealth(2500, 700, 2500)).toBe(700);
      expect(getRespawnHealth(2000, 680, 2000)).toBe(680);
      expect(getRespawnHealth(1500, 520, 1500)).toBe(520);
    });
  });

  describe('残コスト0以下の場合（敗北）', () => {
    test('残コスト0 → 0', () => {
      expect(getRespawnHealth(3000, 800, 0)).toBe(0);
    });

    test('残コスト-1000 → 0', () => {
      expect(getRespawnHealth(3000, 800, -1000)).toBe(0);
    });
  });

  describe('コストオーバー時 - 全58値の回帰テスト', () => {
    // 旧テーブルの全値をtest.eachで検証
    test.each([
      // 3000コスト
      [3000, 800, 500, 140],
      [3000, 800, 1000, 270],
      [3000, 800, 1500, 400],
      [3000, 760, 500, 130],
      [3000, 760, 1000, 260],
      [3000, 760, 1500, 380],
      [3000, 750, 500, 130],
      [3000, 750, 1000, 250],
      [3000, 750, 1500, 380],
      [3000, 740, 500, 130],
      [3000, 740, 1000, 250],
      [3000, 740, 1500, 370],
      // TODO: ゲーム内実測で計算式の値（360）と一致した場合はこの期待値を360に変更する
      [3000, 720, 500, 120],
      [3000, 720, 1000, 240],
      [3000, 720, 1500, 350],
      [3000, 700, 500, 120],
      [3000, 700, 1000, 240],
      [3000, 700, 1500, 350],
      [3000, 680, 500, 120],
      [3000, 680, 1000, 230],
      [3000, 680, 1500, 340],
      [3000, 660, 500, 110],
      [3000, 660, 1000, 220],
      [3000, 660, 1500, 330],
      [3000, 650, 500, 110],
      [3000, 650, 1000, 220],
      [3000, 650, 1500, 330],
      [3000, 640, 500, 110],
      [3000, 640, 1000, 220],
      [3000, 640, 1500, 320],
      // 2500コスト
      [2500, 700, 500, 140],
      [2500, 700, 1000, 280],
      [2500, 700, 1500, 420],
      [2500, 700, 2000, 560],
      [2500, 680, 500, 140],
      [2500, 680, 1000, 280],
      [2500, 680, 1500, 410],
      [2500, 680, 2000, 550],
      [2500, 660, 500, 140],
      [2500, 660, 1000, 270],
      [2500, 660, 1500, 400],
      [2500, 660, 2000, 530],
      [2500, 650, 500, 130],
      [2500, 650, 1000, 260],
      [2500, 650, 1500, 390],
      [2500, 650, 2000, 520],
      [2500, 640, 500, 130],
      [2500, 640, 1000, 260],
      [2500, 640, 1500, 390],
      [2500, 640, 2000, 520],
      [2500, 620, 500, 130],
      [2500, 620, 1000, 250],
      [2500, 620, 1500, 380],
      [2500, 620, 2000, 500],
      [2500, 600, 500, 120],
      [2500, 600, 1000, 240],
      [2500, 600, 1500, 360],
      [2500, 600, 2000, 480],
      // 2000コスト
      [2000, 680, 500, 170],
      [2000, 680, 1000, 340],
      [2000, 680, 1500, 510],
      // TODO: ゲーム内実測で計算式の値（330）と一致した場合はこの期待値を330に変更する
      [2000, 660, 500, 170],
      [2000, 660, 1000, 340],
      [2000, 660, 1500, 500],
      [2000, 650, 500, 170],
      [2000, 650, 1000, 330],
      [2000, 650, 1500, 490],
      [2000, 640, 500, 160],
      [2000, 640, 1000, 320],
      [2000, 640, 1500, 480],
      [2000, 620, 500, 160],
      [2000, 620, 1000, 310],
      [2000, 620, 1500, 470],
      [2000, 600, 500, 150],
      [2000, 600, 1000, 300],
      [2000, 600, 1500, 450],
      [2000, 580, 500, 150],
      [2000, 580, 1000, 290],
      [2000, 580, 1500, 440],
      // 1500コスト
      [1500, 520, 500, 180],
      [1500, 520, 1000, 350],
      [1500, 500, 500, 170],
      [1500, 500, 1000, 340],
      [1500, 480, 500, 160],
      [1500, 480, 1000, 320],
      [1500, 460, 500, 160],
      [1500, 460, 1000, 310],
      [1500, 440, 500, 150],
      [1500, 440, 1000, 300],
    ] as const)(
      'コスト%i 耐久%i 残コスト%i → %i',
      (cost, health, remainingCost, expected) => {
        // 旧テーブルには mobileSuitsData に存在しない耐久値（460, 740）も含まれていたため
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        expect(getRespawnHealth(cost, health as any, remainingCost)).toBe(expected);
      }
    );
  });

  describe('1500/540のコストオーバー（旧テーブル未登録）', () => {
    test('残500 → 180', () => {
      // Math.ceil(540 * 500 / 1500 / 10) * 10 = Math.ceil(18) * 10 = 180
      expect(getRespawnHealth(1500, 540, 500)).toBe(180);
    });

    test('残1000 → 360', () => {
      // Math.ceil(540 * 1000 / 1500 / 10) * 10 = Math.ceil(36) * 10 = 360
      expect(getRespawnHealth(1500, 540, 1000)).toBe(360);
    });
  });

  describe('境界値テスト', () => {
    test('残コスト1（最小正値）→ 計算式で算出', () => {
      // Math.ceil(800 * 1 / 3000 / 10) * 10 = Math.ceil(0.02666...) * 10 = 10
      expect(getRespawnHealth(3000, 800, 1)).toBe(10);
    });

    test('残コストがコスト-1（ギリギリコストオーバー）', () => {
      // 3000コスト、残2999
      // Math.ceil(800 * 2999 / 3000 / 10) * 10 = Math.ceil(79.97...) * 10 = 800
      expect(getRespawnHealth(3000, 800, 2999)).toBe(800);
    });

    test('残コスト500で各コストの計算が正しい', () => {
      // 代表的な値で計算式の正しさを確認
      expect(getRespawnHealth(3000, 800, 500)).toBe(140);
      expect(getRespawnHealth(2500, 700, 500)).toBe(140);
      expect(getRespawnHealth(2000, 680, 500)).toBe(170);
      expect(getRespawnHealth(1500, 520, 500)).toBe(180);
    });
  });
});
