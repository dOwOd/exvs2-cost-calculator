---
import '../styles/global.css';
import Header from '../components/Header.astro';
import { ENABLE_AD_COOKIES, AD_PUBLISHER_ID, CF_ANALYTICS_TOKEN } from '../lib/cookieConsent';

interface Props {
  title: string;
  description: string;
  ogType?: string;
}

const { title, description, ogType = 'website' } = Astro.props;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;
const ogImageUrl = new URL(`${import.meta.env.BASE_URL}ogp.png`, Astro.site).href;
const showAds = ENABLE_AD_COOKIES && AD_PUBLISHER_ID !== '';
const showCfAnalytics = CF_ANALYTICS_TOKEN !== '';
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
    <link rel="icon" href={`${import.meta.env.BASE_URL}favicon.ico`} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- OGP -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:site_name" content="EXVS2 コスト計算機" />
    <meta property="og:locale" content="ja_JP" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <meta name="theme-color" content="#0f172a" id="theme-color-meta" />

    <!-- テーマ初期化（FOUCを防ぐためhead内で実行） -->
    <script is:inline>
      (function () {
        const stored = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        let isDark;
        if (stored === 'dark') {
          isDark = true;
        } else if (stored === 'light') {
          isDark = false;
        } else {
          isDark = systemDark;
        }

        if (isDark) {
          document.documentElement.classList.add('dark');
        }

        const meta = document.getElementById('theme-color-meta');
        if (meta) {
          meta.setAttribute('content', isDark ? '#0f172a' : '#f1f5f9');
        }
      })();
    </script>

    {
      showAds && (
        <script
          async
          src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${AD_PUBLISHER_ID}`}
          crossorigin="anonymous"
        />
      )
    }

    <slot name="head" />

    {/* Cloudflare Web Analytics (Cookie不要 - トークン設定時のみロード) */}
    {
      showCfAnalytics && (
        <script
          defer
          src="https://static.cloudflareinsights.com/beacon.min.js"
          data-cf-beacon={`{"token":"${CF_ANALYTICS_TOKEN}"}`}
        />
      )
    }
  </head>
  <body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">
    <Header />
    <slot />

    {/* GA4 初期化 (consent-gated) */}
    <script>
      import { initAnalytics } from '../lib/analytics';
      initAnalytics();
    </script>
  </body>
</html>
