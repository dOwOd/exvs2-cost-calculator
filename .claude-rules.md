# Claude Code セッション管理ルール

このファイルは、Claude Code との対話セッションにおける運用ルールを定義します。

## 📋 新しいセッション開始時の手順

新しいセッションを始める際は、Claude に以下を依頼してください：

```
まず .claude-rules.md を読んで、このプロジェクトのルールに従ってください。
```

## 🔄 コンテキストクリアの確認タイミング

以下のタイミングで、**ユーザーに `/clear` の実行を確認してください**：

### 1. トークン使用率ベース
- ✅ **トークン使用率が80%を超えた時**
  - システムメッセージの `Token usage: X/200000` を監視
  - 160,000トークン以上使用した時点で確認

### 2. フェーズ移行ベース
以下のようなフェーズ移行を検知した時：

- ✅ **設計 → 実装**
  - 「実装を始めます」
  - 「コーディング開始」
  - 「プロジェクトセットアップ」
  - 「Astroプロジェクトを作成」

- ✅ **実装 → テスト**
  - 「テストを書きます」
  - 「テストフェーズに入ります」

- ✅ **プロジェクト完了**
  - 「このプロジェクトは完了」
  - 「アーカイブします」

- ✅ **別プロジェクトへの移行**
  - 「新しいプロジェクトを始めます」
  - 「別のアイデアに移ります」

### 3. 確認メッセージのテンプレート

以下のように確認してください：

```
💡 コンテキストクリアの確認

現在のトークン使用率: XX% (XXX,XXX / 200,000)
理由: [フェーズ移行 / トークン使用率80%超過]

クリア前のチェックリスト:
- [ ] 重要な決定事項はファイルに保存済み
- [ ] README.mdは最新の状態
- [ ] 次のステップはTODOに記録済み

`/clear` を実行しますか？
```

## ✅ クリア前のチェックリスト

`/clear` を実行する前に、以下を確認してください：

### 必須項目
- [ ] **重要な決定事項を記録**
  - `decisions/` フォルダにADRとして保存
  - 技術選定、設計方針などを文書化

- [ ] **README.mdを最新化**
  - プロジェクトの現在の状態を反映
  - 次のステップを明記

- [ ] **設計ドキュメントを保存**
  - ワイヤーフレーム、アーキテクチャ図など
  - `design/` フォルダに整理

- [ ] **未完了タスクを記録**
  - TODO リストに追加
  - 優先順位を明記

### 推奨項目
- [ ] **対話の要約を保存**
  - `sessions/` フォルダに日付ベースで保存
  - 重要な議論のポイントをまとめる

- [ ] **次回セッションの準備**
  - README に「次回開始時に読むべきファイル」をリスト化
  - 必要なコマンドをメモ

## 🎯 フェーズごとの推奨アクション

### 設計フェーズ
- コンテキスト保持: **推奨**
- 理由: 議論の流れが重要
- クリアタイミング: 実装開始直前

### 実装フェーズ
- コンテキスト保持: **推奨**
- 理由: ファイル間の関連性を保持
- クリアタイミング: 大きな機能の区切り

### テストフェーズ
- コンテキスト保持: **任意**
- 理由: 実装の詳細は不要な場合あり
- クリアタイミング: テスト開始時

### リファクタリング
- コンテキスト保持: **任意**
- 理由: 実装コードを読めば十分な場合あり
- クリアタイミング: リファクタリング開始時

## 📊 トークン管理のベストプラクティス

### 効率的なコンテキスト利用
- ✅ **重要な情報はファイルに保存**
  - 会話で決まったことは即座に文書化
  - Claude に頼らず、ファイルを真実の情報源に

- ✅ **長い調査結果はファイル化**
  - `research/` フォルダに保存
  - 必要な時だけ参照

- ✅ **定期的なドキュメント更新**
  - 会話の途中でも重要な決定は即座に記録
  - 後から思い出す必要をなくす

### 避けるべきパターン
- ❌ 同じ質問を何度も繰り返す
- ❌ 過去の会話に依存しすぎる
- ❌ ファイルに記録せず会話だけで進める

## 🔧 その他のセッション管理ルール

### 言語設定
- **全ての応答は日本語で**
- コードコメントや変数名は英語OK

### トークン使用率の表示
- **毎回の応答の最後にトークン使用率を表示**
  - 形式: `現在のトークン使用率: XX% (XXX,XXX / 200,000)`
  - 80%を超えた場合は警告を追加

### ファイル操作
- **読む前に書かない**
  - 既存ファイルを編集する際は必ず先に Read

- **編集より新規作成を避ける**
  - 既存ファイルがあれば Edit を優先

### タスク管理
- **複数の独立したタスクは並列実行**
  - ファイル読み込み、検索などは並列に

- **依存関係があるタスクは直列実行**
  - Write → Bash など

## 📝 セッション記録のテンプレート

新しいセッションの記録は以下の形式で保存：

```markdown
# セッション記録: YYYY-MM-DD

## 目的
[このセッションで達成したいこと]

## 実施内容
- [実施したタスク1]
- [実施したタスク2]

## 決定事項
- [重要な決定1]
- [重要な決定2]

## 次回のアクション
- [ ] [次にやるべきこと1]
- [ ] [次にやるべきこと2]

## メモ
[その他気づいたこと、注意点など]
```

---

## 🚀 クイックスタートガイド

### 新しいセッション開始時
1. Claude に `.claude-rules.md` を読んでもらう
2. プロジェクトの README.md を読んでもらう
3. 今日のタスクを伝える

### セッション終了時
1. 重要な決定事項をファイルに保存
2. README の「次のアクション」を更新
3. 必要に応じて `/clear`

---

**最終更新**: 2026-01-24
**バージョン**: 1.0
